{"version":3,"sources":["skylark-jsbin-processors.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"../skylark-jsbin-processors.js","sourcesContent":["define('skylark-jsbin-processors/jsbin',[\r\n  \"skylark-jsbin-base\"\r\n],function(jsbin){\r\n  return jsbin;\r\n});\r\n\r\n\ndefine('skylark-jsbin-processors/processors',[\r\n  \"skylark-jquery\",\r\n  \"./jsbin\"\r\n],function($,jsbin){\r\n\r\n  /*globals jsbin, _$, renderLivePreview, editors, throttle, debounceAsync, hintingDone, CodeMirror, Panel, editorModes */\r\n  'use strict';\r\n  /*\r\n   * Debugging note: to emulate a slow connection, or a processor taking too\r\n   * long to load, find the processor in question, and change the `init` method\r\n   * to setTimeout(getScript, n seconds) - this will give you an idea of how\r\n   * jsbin behaves when the processor isn't ready and the user makes calls to it\r\n   */\r\n\r\n\r\n  /**\r\n   * Add properties to a function using underscore\r\n   */\r\n  var extendFn = function (fn, obj) {\r\n    return $.extend(fn, obj);\r\n  };\r\n\r\n  var passthrough = function (ready) { return ready(); };\r\n  var defaultProcessor = function (source, resolve, reject) {\r\n    return new Promise(function (resolve) {\r\n      resolve(source);\r\n    }).then(resolve, reject);\r\n  };\r\n\r\n  /**\r\n   * Cache extension ids by their file extensions\r\n   */\r\n  var processorBy = {\r\n    extension: {},\r\n  };\r\n\r\n  /**\r\n   * A version of $.getScript, but using our jsbin version\r\n   * as the cachebuster\r\n   */\r\n  var getScript = function (url, callback) {\r\n    $.ajax({\r\n      cache: true,\r\n      url: url + '?' + jsbin.version,\r\n      dataType: 'script',\r\n      success: callback\r\n    });\r\n  };\r\n\r\n  function pick() {\r\n    var args = [].slice.call(arguments, 0);\r\n    var target = args.shift();\r\n    return args.reduce(function (acc, curr) {\r\n      acc[curr] = target[curr] || null;\r\n      return acc;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * Create a processor – accepts an object containing:\r\n   *\r\n   *    id          Processor name. Required.\r\n   *    target      The target panel. Optional - defaults to the id.\r\n   *    extensions  Possible file extensions for this processor (for gist i/o).\r\n   *                Optional. Defaults to the id.\r\n   *    url         URL of the loader script file. Optional.\r\n   *    init        Setup the processor here. Optional – defaults to the\r\n   *                passthrough (above).\r\n   *    handler     Where the magic happens. Do all processing in here.\r\n   *                Optional - defaults to the defaultProcessor (above).\r\n   */\r\n  var createProcessor = function (opts) {\r\n    var url = opts.url,\r\n        init = opts.init || passthrough,\r\n        handler = opts.handler || defaultProcessor,\r\n        processorData = pick(opts, 'id', 'target', 'extensions');\r\n\r\n    opts.extensions = opts.extensions || [];\r\n    if (!opts.extensions.length) {\r\n      opts.extensions = [opts.id];\r\n    }\r\n\r\n    opts.extensions.forEach(function (ext) {\r\n      processorBy.extension[ext] = opts.id;\r\n    });\r\n\r\n    // This actually loads in the processor – script files & init code\r\n    var loadProcessor = function (ready) {\r\n\r\n      var failed = false;\r\n\r\n      // Overwritten when the script loads\r\n      var callback = function () {\r\n        if (window.console) {\r\n          window.console.warn('Processor is not ready yet - trying again');\r\n        }\r\n        failed = true;\r\n        return '';\r\n      };\r\n\r\n      // Script has loaded.\r\n      // Run any init code, and swap the callback. If we failed, try again.\r\n      var scriptCB = function () {\r\n        init(function () {\r\n          callback = handler;\r\n          if (failed) {\r\n            renderLivePreview();\r\n          }\r\n          ready();\r\n        });\r\n      };\r\n\r\n      if (url) {\r\n        // Load the processor's script\r\n        getScript(url, scriptCB);\r\n      } else {\r\n        // No url, go straight on\r\n        init(function () {\r\n          callback = handler;\r\n          ready();\r\n        });\r\n      }\r\n\r\n      // Create a proxy function that holds the handler in scope so that, when\r\n      // the callbacks are swapped, rendering still works.\r\n      var cache = {\r\n        source: '',\r\n        result: ''\r\n      };\r\n\r\n      if (processorData.target) {\r\n        if (!jsbin.state.cache) {\r\n          jsbin.state.cache = {};\r\n        }\r\n        jsbin.state.cache[processorData.target] = cache;\r\n      }\r\n      var proxyCallback = function (source) {\r\n        return new Promise(function (resolve, reject) {\r\n          source = source.trim();\r\n          if (source === cache.source) {\r\n            resolve(cache.result);\r\n          } else {\r\n            callback(source, function (result) {\r\n              cache.source = source;\r\n              cache.result = result;\r\n              resolve(result);\r\n            }, reject);\r\n          }\r\n        });\r\n      };\r\n\r\n      // Return the method that will be used to render\r\n      return extendFn(proxyCallback, processorData);\r\n    };\r\n\r\n    // Processor fucntion also has the important data on it\r\n    return extendFn(loadProcessor, processorData);\r\n  };\r\n\r\n  /**\r\n   * JS Bin's processors\r\n   */\r\n  var processors = {\r\n\r\n    html: createProcessor({\r\n      id: 'html',\r\n      extensions: ['html']\r\n    }),\r\n\r\n    css: createProcessor({\r\n      id: 'css',\r\n      extensions: ['css']\r\n    }),\r\n\r\n    javascript: createProcessor({\r\n      id: 'javascript',\r\n      extensions: ['js']\r\n    }),\r\n\r\n    coffeescript: createProcessor({\r\n      id: 'coffeescript',\r\n      target: 'javascript',\r\n      extensions: ['coffee'],\r\n      url: jsbin.static + '/js/vendor/coffee-script.js',\r\n      init: function coffeescript(ready) {\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/coffeescript/coffeescript.js', ready);\r\n      },\r\n      handler: function (source, resolve, reject) {\r\n        var renderedCode = '';\r\n        try {\r\n          renderedCode = window.CoffeeScript.compile(source, {\r\n            bare: true\r\n          });\r\n          resolve(renderedCode);\r\n        } catch (e) {\r\n          var errors = {\r\n            line: parseInt(e.location.first_line, 10) || 0, // jshint ignore:line\r\n            ch: parseInt(e.location.first_column, 10) || 0, // jshint ignore:line\r\n            msg: e.message\r\n          };\r\n\r\n          reject([errors]);\r\n        }\r\n      }\r\n    }),\r\n\r\n    jsx: createProcessor({\r\n      id: 'jsx',\r\n      target: 'javascript',\r\n      extensions: ['jsx'],\r\n      url: jsbin.static + '/js/vendor/JSXTransformer.js',\r\n      init: function jsx(ready) {\r\n        // Don't add React if the code already contains a script whose name\r\n        // starts with 'react', to avoid duplicate copies.\r\n        var code = editors.html.getCode();\r\n        if (!(/<script[^>]*src=\\S*\\breact\\b/i).test(code)) {\r\n          $('#library').val( $('#library').find(':contains(\"React with Add-Ons\")').val() ).trigger('change');\r\n        }\r\n        ready();\r\n      },\r\n      handler: function (source, resolve, reject) {\r\n        var renderedCode = '';\r\n        try {\r\n          renderedCode = window.JSXTransformer.transform(source).code;\r\n          resolve(renderedCode);\r\n        } catch (e) {\r\n          reject(e);\r\n        }\r\n      }\r\n    }),\r\n\r\n    livescript: createProcessor({\r\n      id: 'livescript',\r\n      target: 'javascript',\r\n      extensions: ['ls'],\r\n      url: jsbin.static + '/js/vendor/livescript.js',\r\n      init: function livescript(ready) {\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/livescript/livescript.js', ready);\r\n      },\r\n      handler: function (source, resolve, reject) {\r\n        var renderedCode = '';\r\n        try {\r\n          renderedCode = window.LiveScript.compile(source, {\r\n            bare: true\r\n          });\r\n          resolve(renderedCode);\r\n        } catch (e) {\r\n          // index starts at 1\r\n          var lineMatch = e.message.match(/on line (\\d+)/) || [,];\r\n          var line = parseInt(lineMatch[1], 10) || 0;\r\n          if (line > 0) {\r\n            line = line - 1;\r\n          }\r\n          var msg = e.message.match(/(.+) on line (\\d+)$/) || [,];\r\n          var errors = {\r\n            line: line,\r\n            ch: null,\r\n            msg: msg[1]\r\n          };\r\n\r\n          reject([errors]);\r\n        }\r\n      },\r\n    }),\r\n\r\n    typescript: createProcessor({\r\n      id: 'typescript',\r\n      target: 'javascript',\r\n      extensions: ['ts'],\r\n      url: jsbin.static + '/js/vendor/typescript.min.js',\r\n      init: passthrough,\r\n      handler: function typescript(source, resolve, reject) {\r\n\r\n        var result = ts.transpileModule(source, {\r\n          compilerOptions: {\r\n            inlineSourceMap: true,\r\n            inlineSources: true,\r\n            target: ts.ScriptTarget.ES5\r\n          },\r\n          fileName: 'jsbin.ts',\r\n          reportDiagnostics: true\r\n        });\r\n\r\n        /**\r\n         *  TypeScript is complaining about the `isolateModules` setting, which\r\n         *  is meant to ignore import statements. We don't want to show that to\r\n         *  the user, so we just filter it out.\r\n         */\r\n        var diagnostics = result.diagnostics.filter(function(error){\r\n          return error.code !== 5047;\r\n        });\r\n\r\n        if (diagnostics.length) {\r\n          reject(diagnostics.map(function(diagnostic){\r\n            var position  = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);\r\n            var line = position.line + 1;\r\n            var character = position.character + 1;\r\n            var message = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\\n');\r\n            var code = source.substr(diagnostic.start, diagnostic.length);\r\n            return message + (code ? ' at ' + code : '') +\r\n              ' (' + diagnostic.file.fileName + ':'+line+':'+character+')';\r\n          }).join('\\n'));\r\n        } else {\r\n          resolve(result.outputText);\r\n        }\r\n      }\r\n    }),\r\n\r\n    markdown: createProcessor({\r\n      id: 'markdown',\r\n      target: 'html',\r\n      extensions: ['md', 'markdown', 'mdown'],\r\n      url: jsbin.static + '/js/vendor/marked.min.js',\r\n      init: function markdown(ready) {\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/markdown/markdown.js', ready);\r\n      },\r\n      handler: function (source, resolve, reject) {\r\n        try {\r\n          resolve(window.marked(source));\r\n        } catch (e) {\r\n          reject(e);\r\n        }\r\n      }\r\n    }),\r\n\r\n    processing: createProcessor({\r\n      id: 'processing',\r\n      target: 'javascript',\r\n      extensions: ['pde'],\r\n      url: jsbin.static + '/js/vendor/processing.min.js',\r\n      init: function (ready) {\r\n        $('#library').val( $('#library').find(':contains(\"Processing\")').val() ).trigger('change');\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/clike/clike.js', ready);\r\n      },\r\n      handler: function processing(source, resolve, reject) {\r\n        try {\r\n          var sketch = window.Processing.compile(source).sourceCode;\r\n          resolve([\r\n            '(function(){',\r\n            '  var canvas = document.querySelector(\"canvas\");',\r\n            '  if (!canvas) {',\r\n            '    canvas = document.createElement(\"canvas\");',\r\n            '    (document.body || document.documentElement).appendChild(canvas);',\r\n            '  }',\r\n            '  canvas.width = window.innerWidth;',\r\n            '  canvas.height = window.innerHeight;',\r\n            '  var sketchProc = ' + sketch + ';',\r\n            '  var p = new Processing(canvas, sketchProc);',\r\n            '})();'\r\n          ].join('\\n'));\r\n        } catch (e) {\r\n          reject(e);\r\n        }\r\n      }\r\n    }),\r\n\r\n    jade: createProcessor({\r\n      id: 'jade',\r\n      target: 'html',\r\n      extensions: ['jade'],\r\n      url: jsbin.static + '/js/vendor/jade.js?1.4.2',\r\n      init: function jade(ready) {\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/jade/jade.js', ready);\r\n      },\r\n      handler: function jade(source, resolve, reject) {\r\n        try {\r\n          resolve(window.jade.compile(source, { pretty: true })());\r\n        } catch (e) {\r\n          console.log('Errors', e);\r\n          // index starts at 1\r\n          var lineMatch = e.message.match(/Jade:(\\d+)/) || [,];\r\n          var line = parseInt(lineMatch[1], 10) || 0;\r\n          if (line > 0) {\r\n            line = line - 1;\r\n          }\r\n          var msg = e.message.match(/\\n\\n(.+)$/) || [,];\r\n          var errors = {\r\n            line: line,\r\n            ch: null,\r\n            msg: msg[1]\r\n          };\r\n\r\n          reject([errors]);\r\n        }\r\n      }\r\n    }),\r\n\r\n    less: createProcessor({\r\n      id: 'less',\r\n      target: 'css',\r\n      extensions: ['less'],\r\n      url: jsbin.static + '/js/vendor/less.min.js',\r\n      init: passthrough,\r\n      handler: function less(source, resolve, reject) {\r\n        window.less.render(source, function (error, result) {\r\n          if (error) {\r\n            // index starts at 1\r\n            var line = parseInt(error.line, 10) || 0;\r\n            var ch = parseInt(error.column, 10) || 0;\r\n            if (line > 0) {\r\n              line = line - 1;\r\n            }\r\n            if (ch > 0) {\r\n              ch = ch - 1;\r\n            }\r\n            var errors = {\r\n              line: line,\r\n              ch: ch,\r\n              msg: error.message\r\n            };\r\n\r\n            return reject([errors]);\r\n          }\r\n          resolve(result.css.trim());\r\n        });\r\n      }\r\n    }),\r\n\r\n    scss: createProcessor({\r\n      id: 'scss',\r\n      target: 'scss',\r\n      extensions: ['scss'],\r\n      // url: jsbin.static + '/js/vendor/sass/dist/sass.worker.js',\r\n      init: passthrough,\r\n        /* keeping old code for local version of scss if we ever want it again */\r\n        // getScript(jsbin.static + '/js/vendor/codemirror3/mode/sass/sass.js', function () {\r\n        // Sass.initialize(jsbin.static + '/js/vendor/sass/dist/worker.min.js');\r\n      handler: throttle(debounceAsync(function sass(source, resolve, reject, done) {\r\n        $.ajax({\r\n          type: 'post',\r\n          url: '/processor',\r\n          data: {\r\n            language: 'scss',\r\n            source: source,\r\n            url: jsbin.state.code,\r\n            revision: jsbin.state.revision\r\n          },\r\n          success: function (data) {\r\n            if (data.errors) {\r\n              // console.log(data.errors);\r\n              var cm = jsbin.panels.panels.css.editor;\r\n              if (typeof cm.updateLinting !== 'undefined') {\r\n                hintingDone(cm);\r\n                var err = formatErrors(data.errors);\r\n                cm.updateLinting(err);\r\n              }\r\n            } else if (data.result) {\r\n              resolve(data.result);\r\n            }\r\n          },\r\n          error: function (jqxhr) {\r\n            reject(new Error(jqxhr.responseText));\r\n          },\r\n          complete: done\r\n        });\r\n        // RS: keep this as it's the client side version of SCSS support...\r\n        // Sass.compile(source, function (result) {\r\n        //   if (typeof result !== 'string') {\r\n        //     reject(new Error('Error on line ' + result.line + ':\\n' + result.message));\r\n        //   } else {\r\n        //     resolve(result.trim());\r\n        //   }\r\n        // });\r\n      }), 500),\r\n    }),\r\n\r\n    sass: createProcessor({\r\n      id: 'sass',\r\n      target: 'sass',\r\n      extensions: ['sass'],\r\n      init: function (ready) {\r\n        getScript(jsbin.static + '/js/vendor/codemirror5/mode/sass/sass.js', ready);\r\n      },\r\n      handler: throttle(debounceAsync(function (source, resolve, reject, done) {\r\n        $.ajax({\r\n          type: 'post',\r\n          url: '/processor',\r\n          data: {\r\n            language: 'sass',\r\n            source: source,\r\n            url: jsbin.state.code,\r\n            revision: jsbin.state.revision\r\n          },\r\n          success: function (data) {\r\n            if (data.errors) {\r\n              // console.log(data.errors);\r\n              var cm = jsbin.panels.panels.css.editor;\r\n              if (typeof cm.updateLinting !== 'undefined') {\r\n                hintingDone(cm);\r\n                var err = formatErrors(data.errors);\r\n                cm.updateLinting(err);\r\n              }\r\n            } else if (data.result) {\r\n              resolve(data.result);\r\n            }\r\n          },\r\n          error: function (jqxhr) {\r\n            reject(new Error(jqxhr.responseText));\r\n          },\r\n          complete: done\r\n        });\r\n      }), 500),\r\n    }),\r\n\r\n    babel: createProcessor({\r\n      id: 'babel',\r\n      target: 'js',\r\n      extensions: ['es6'],\r\n      url: jsbin.static + '/js/vendor/babel.min.js',\r\n      init: function (ready) {\r\n        ready();\r\n      },\r\n      handler: function babelhandle(source, resolve, reject) {\r\n        try {\r\n          resolve(babel.transform(source, { stage: 0 }).code);\r\n        } catch (e) {\r\n          console.error(e.message);\r\n          reject([{\r\n            line: e.loc.line - 1,\r\n            ch: e.loc.column,\r\n            msg: e.message.split('\\n')[0].replace(new RegExp('\\\\\\(' + e.loc.line + ':' + e.loc.column + '\\\\\\)'), '(' + e.loc.column + ')')\r\n          }]);\r\n        }\r\n      }\r\n    }),\r\n\r\n    myth: createProcessor({\r\n      id: 'myth',\r\n      target: 'css',\r\n      extensions: ['myth'],\r\n      url: jsbin.static + '/js/vendor/myth.min.js',\r\n      init: function (ready) {\r\n        ready();\r\n      },\r\n      handler: function (source, resolve, reject) {\r\n        try {\r\n          resolve(window.myth(source));\r\n        } catch (e) {\r\n          // index starts at 1\r\n          var line = parseInt(e.line, 10) || 0;\r\n          var ch = parseInt(e.column, 10) || 0;\r\n          if (line > 0) {\r\n            line = line - 1;\r\n          }\r\n          if (ch > 0) {\r\n            ch = ch - 1;\r\n          }\r\n          var errors = {\r\n            line: line,\r\n            ch: ch,\r\n            msg: e.message\r\n          };\r\n\r\n          reject([errors]);\r\n        }\r\n      }\r\n    }),\r\n\r\n    stylus: createProcessor({\r\n      id: 'stylus',\r\n      target: 'css',\r\n      extensions: ['styl'],\r\n      url: jsbin.static + '/js/vendor/stylus.js',\r\n      init: passthrough,\r\n      handler: function stylus(source, resolve, reject) {\r\n        window.stylus(source).render(function (error, result) {\r\n          if (error) {\r\n            // index starts at 1\r\n            var lineMatch = error.message.match(/stylus:(\\d+)/) || [,];\r\n            var line = parseInt(lineMatch[1], 10) || 0;\r\n            var msg = error.message.match(/\\n\\n(.+)\\n$/) || [,];\r\n            if (line > 0) {\r\n              line = line - 1;\r\n            }\r\n            var errors = {\r\n              line: line,\r\n              ch: null,\r\n              msg: msg[1]\r\n            };\r\n\r\n            return reject([errors]);\r\n          }\r\n\r\n          resolve(result.trim());\r\n        });\r\n      }\r\n    }),\r\n\r\n    clojurescript: (function() {\r\n\r\n      var worker, resolveWorker;\r\n\r\n      function workerMsgHandler() {\r\n        window.addEventListener('message', function(event) {\r\n          var message;\r\n          try {\r\n            message = JSON.parse(event.data);\r\n          } catch (e) {\r\n            return;\r\n          }\r\n\r\n          if (message.type === 'eval') {\r\n            jsbin_cljs.core.eval(\r\n              '(ns cljs.user)' + message.source,\r\n              function(err, result) {\r\n                cljs.user = null;\r\n                if (err) {\r\n                  throw Error(err);\r\n                } else {\r\n                  parent.postMessage(JSON.stringify({\r\n                    type: 'eval',\r\n                    result: result\r\n                  }), '*');\r\n                }\r\n              });\r\n          }\r\n        }, false);\r\n      }\r\n\r\n      window.addEventListener('message', function(event) {\r\n        try {\r\n          var message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;\r\n\r\n          if (message.type === 'eval') {\r\n            resolveWorker('console.log('+JSON.stringify(message.result)+')');\r\n          }\r\n        } catch (e) {\r\n          // toss errors\r\n        }\r\n      }, false);\r\n\r\n      return createProcessor({\r\n        id: 'clojurescript',\r\n        target: 'js',\r\n        extensions: ['clj', 'cljs'],\r\n        url: jsbin.static + '/js/vendor/cljs.js',\r\n        init: function clojurescript(ready) {\r\n\r\n          /* Create sandbox */\r\n          worker = document.createElement('iframe');\r\n          worker.sandbox = 'allow-same-origin allow-scripts';\r\n          worker.name = '<cljs>';\r\n\r\n          worker.onload = function() {\r\n            /* Init CLJS context */\r\n            worker.contentWindow.jsbin_cljs = jsbin_cljs;\r\n            worker.contentWindow.cljs = cljs;\r\n            worker.contentWindow.goog = goog;\r\n\r\n            var initilizer = worker.contentWindow.document.createElement('script')\r\n            initilizer.textContent = '('+workerMsgHandler.toString().split('\\n').join('')+')()';\r\n            worker.contentWindow.document.body.appendChild(initilizer);\r\n\r\n            getScript(jsbin.static + '/js/vendor/codemirror5/mode/clojure/clojure.js', ready);\r\n          };\r\n\r\n          document.body.appendChild(worker);\r\n        },\r\n        handler: function (source, resolve, reject) {\r\n          try {\r\n            resolveWorker = resolve;\r\n            worker.contentWindow.postMessage(JSON.stringify({\r\n              type: 'eval',\r\n              source: source\r\n            }), '*');\r\n          } catch (e) {\r\n            console.error(e);\r\n          }\r\n        }\r\n      })\r\n    })(),\r\n\r\n    traceur: (function () {\r\n      var SourceMapConsumer,\r\n          SourceMapGenerator,\r\n          ProjectWriter,\r\n          ErrorReporter,\r\n          hasError;\r\n      return createProcessor({\r\n        id: 'traceur',\r\n        target: 'javascript',\r\n        extensions: ['traceur'],\r\n        url: jsbin.static + '/js/vendor/traceur.js',\r\n        init: function (ready) {\r\n          // Only create these once, when the processor is loaded\r\n          $('#library').val( $('#library').find(':contains(\"Traceur\")').val() ).trigger('change');\r\n          SourceMapConsumer = window.traceur.outputgeneration.SourceMapConsumer;\r\n          SourceMapGenerator = window.traceur.outputgeneration.SourceMapGenerator;\r\n          ProjectWriter = window.traceur.outputgeneration.ProjectWriter;\r\n          ErrorReporter = window.traceur.util.ErrorReporter;\r\n          ready();\r\n        },\r\n        handler: function (source, resolve, reject) {\r\n          hasError = false;\r\n\r\n          var reporter = new ErrorReporter();\r\n          reporter.reportMessageInternal = function(location, kind, format, args) {\r\n            reject(new Error(ErrorReporter.format(location, format, args)));\r\n          };\r\n\r\n          var url = location.href;\r\n          var project = new window.traceur.semantics.symbols.Project(url);\r\n          var name = 'jsbin';\r\n\r\n          var sourceFile = new window.traceur.syntax.SourceFile(name, source);\r\n          project.addFile(sourceFile);\r\n          var res = window.traceur.codegeneration.Compiler.compile(reporter, project, false);\r\n\r\n          var msg = '/*\\nIf you\\'ve just translated to JS, make sure traceur is in the HTML panel.\\nThis is terrible, sorry, but the only way we could get around race conditions.\\n\\nHugs & kisses,\\nDave xox\\n*/\\ntry{window.traceur = top.traceur;}catch(e){}\\n';\r\n          resolve(msg + ProjectWriter.write(res));\r\n        }\r\n      });\r\n    }())\r\n\r\n  };\r\n\r\n  var formatErrors = function(res) {\r\n    var errors = [];\r\n    var line = 0;\r\n    var ch = 0;\r\n    for (var i = 0; i < res.length; i++) {\r\n      line = res[i].line || 0;\r\n      ch = res[i].ch || 0;\r\n      errors.push({\r\n        from:  {line,ch}, ///CodeMirror.Pos(line, ch),\r\n        to:  {line,ch} , ///CodeMirror.Pos(line, ch),\r\n        message: res[i].msg,\r\n        severity : 'error'\r\n      });\r\n    }\r\n    return errors;\r\n  };\r\n\r\n\r\n  /**\r\n   * Find the processor that uses the given file extension\r\n   */\r\n  processors.findByExtension = function (ext) {\r\n    var id = processorBy.extension[ext];\r\n    if (!id) {\r\n      return defaultProcessor;\r\n    }\r\n    return processors[id];\r\n  };\r\n\r\n  processors.by = processorBy;\r\n\r\n  return jsbin.processors = processors;\r\n\r\n});\r\n\ndefine('skylark-jsbin-processors/main',[\r\n\t\"./processors\"\r\n],function(processors){\r\n\treturn processors;\r\n});\ndefine('skylark-jsbin-processors', ['skylark-jsbin-processors/main'], function (main) { return main; });\n\n"]}